<!DOCTYPE html>
<html>
<head>
    <title>Map with Plain Text Labels and Form</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100vh;
            width: 100%;
        }	

        .custom-label span {
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.7);
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 20px;
            font-weight: bold;
        }

        .form-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .form-overlay input, .form-overlay select, .form-overlay button {
            display: block;
            margin: 10px 0;
            padding: 8px;
            font-size: 14px;
            width: 100%;
        }

        .form-overlay button {
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }

        .form-overlay button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="form-overlay">
        <label for="carrier">Carrier:</label>
        <select id="carrier">
            <option value="310260">T-Mobile</option>
            <option value="310410">AT&T</option>
            <option value="311480">Verizon</option>
        </select>

        <label for="cid">Cell ID:</label>
        <input id="cid" type="number" maxlength="6" placeholder="Enter CID" required />

        <label for="tac">TAC:</label>
        <input id="tac" type="number" maxlength="6" placeholder="Enter TAC" required />
		
		<label for="rat">RAT:</label>
		<select name="rat" id="rat">
		<option value="LTE" selected>LTE</option>
		<option value="NR">NR</option>
		</select>
		
        <button id="submitForm">Submit</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/surro@2.0.0/dist/web/surro.js"></script>
    <script>
                    surro.setCorsProxyUrl('https://cmgm.us/faa/proxy/cors_proxy.php?csurl=');
        var map = L.map('map').setView([35.13, -117.93], 13); // Centered view

        // Load OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Function to determine text color based on PLMN
        function getColor(plmn) {
            if (plmn === "310260") return "#DB0070"; // Pink for PLMN 310260
            if (plmn === "311490") return "#DB0070"; // Pink for PLMN 311490
            if (plmn === "311480") return "#F50A23"; // Red for PLMN 311480
            if (plmn === "310410") return "#009EDD"; // Blue for PLMN 310410
            if (plmn === "313100") return "#009EDD"; // Blue for PLMN 313100
            return "#000000"; // Default color (black)
        }

        // Function to update the map with new data
        function updateMap(data) {
            data.forEach(point => {
                var plmn = point.mcc + "" + point.mnc; // Concatenate MCC and MNC to get PLMN
                var color = getColor(plmn);

                // Generate label content with eNB and accuracy

				if (point.eNB == null) {
                  if (plmn == 310260 || plmn == 311490) {
                  var labelText = point.cellId / 4096n;
                  }
                  if (plmn == 311480) {
                  var labelText = point.cellId / 16384n;
                  }
                  if (plmn == 310410 || plmn == 313100) {
                  var labelText = point.cellId / 1024n;
                  }
				} else {
				    var labelText = `${point.eNB}`;
				}

                // Use Leaflet's divIcon to add custom text
                var label = L.divIcon({
                    className: 'custom-label',
                    html: `<span style="color: ${color};">${labelText}</span>`,
                    iconSize: [0, 0] // No default icon size
                });

                // Add the label to the map at the specified location
                L.marker([point.latitude, point.longitude], { icon: label }).addTo(map);
            });
        }
		
		
		async function callApi(carrier, cid, tac, rat) {
		
			// const data = new FormData();
			// data.append('carrier', carrier);
			// data.append('cid', cid);
			// data.append('tac', tac);
			// data.append('rat', rat);

            const mcc = carrier.substring(0,3);
            const mnc = carrier.substring(3);

                    // set surro proxy

            let res = await surro.getSurroundingCells(mcc, mnc, BigInt(cid), BigInt(tac), rat);
            
            if (res.success) {
                return res.data;
            } else {
                console.error('Surro failed to reply:', res);
            }
		
			// const res = await fetch('http://127.0.0.1:1234/geolocate', {
			// 	method: 'POST',
			// 	body: JSON.stringify({
            //         cellTowers: [{
            //             "locationAreaCode": tac,
            //             "cellId": cid,
            //             "mobileCountryCode": mcc,
            //             "mobileNetworkCode": mnc,
            //             "rat": rat
            //         }]
            //     })
			// })
			
			// const json = await res.json();
			
			// return json;
		}

        // Handle form submission
        document.getElementById('submitForm').addEventListener('click', async () => {
		
		// try {
		
			const carrier = document.getElementById('carrier').value;
			const cid = document.getElementById('cid').value;
			const tac = document.getElementById('tac').value;
			const rat = document.getElementById('rat').value;
	
				if (!cid || !tac || !rat) {
					alert('Please fill in all fields.');
					return;
				}
					
				const surroundingCells = await callApi(carrier, cid, tac, rat);
				console.log(surroundingCells);
				// Clear existing markers
				map.eachLayer(layer => {
					if (layer instanceof L.Marker && !layer._icon.classList.contains('leaflet-marker-icon')) {
						map.removeLayer(layer);
					}
				});
				
				// Update map with new data
				updateMap(surroundingCells);
				
			
		// } catch (err) {
		// 	console.error(err);
		// }
	})
    </script>
</body>
</html>